<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

  <changeSet author="ricci" id="1">

    <preConditions onFail="HALT">
      <sqlCheck expectedResult="3.0-Alpha5">select version from
        collect.ofc_application_info</sqlCheck>
    </preConditions>
  
    <dropNotNullConstraint tableName="ofc_taxon"
      columnName="taxon_id" />
  
    <dropNotNullConstraint tableName="ofc_taxon"
      columnName="code" />
  
    <dropUniqueConstraint constraintName="ofc_taxonomy_name_key"
      tableName="ofc_taxonomy" />
  
    <addColumn tableName="ofc_taxonomy">
      <column name="survey_id" type="INTEGER" />
      <column name="survey_work_id" type="INTEGER" />
    </addColumn>
        
    <addUniqueConstraint
      constraintName="ofc_taxonomy_name_key"
      tableName="ofc_taxonomy"
      columnNames="survey_id,name" />
    
    <addUniqueConstraint
      constraintName="ofc_taxonomy_name_work_key"
      tableName="ofc_taxonomy"
      columnNames="survey_work_id,name" />
        
    <addForeignKeyConstraint 
      constraintName="ofc_taxonomy_survey_fkey"
      baseTableName="ofc_taxonomy" 
      baseColumnNames="survey_id"
      referencedTableName="ofc_survey" 
      referencedColumnNames="id" />

    <addForeignKeyConstraint 
      constraintName="ofc_taxonomy_survey_work_fkey"
      baseTableName="ofc_taxonomy" 
      baseColumnNames="survey_work_id"
      referencedTableName="ofc_survey_work" 
      referencedColumnNames="id" />
  
    <createSequence sequenceName="ofc_sampling_design_id_seq" />
  
    <createTable tableName="ofc_sampling_design">
      <column name="id" type="INTEGER">
        <constraints nullable="false" primaryKey="true" />
      </column>
      <column name="survey_id" type="INTEGER" />
      <column name="survey_work_id" type="INTEGER" />
      <column name="level1" type="VARCHAR(255)">
        <constraints nullable="false" />
      </column>
      <column name="level2" type="VARCHAR(255)" />
      <column name="level3" type="VARCHAR(255)" />
      <column name="location" type="VARCHAR(255)">
        <constraints nullable="false" />
      </column>
    </createTable>
        
    <addForeignKeyConstraint 
      constraintName="ofc_sampling_design_survey_fkey"
      baseTableName="ofc_sampling_design" 
      baseColumnNames="survey_id"
      referencedTableName="ofc_survey" 
      referencedColumnNames="id" />
        
    <addForeignKeyConstraint 
      constraintName="ofc_sampling_design_survey_work_fkey"
      baseTableName="ofc_sampling_design" 
      baseColumnNames="survey_work_id"
      referencedTableName="ofc_survey_work" 
      referencedColumnNames="id" />
        
    <addUniqueConstraint
      constraintName="ofc_user_username_key"
      tableName="ofc_user"
      columnNames="username" />
        
    <update tableName="ofc_application_info">
      <column name="version" value="3.0-Alpha6" />
      <where>true</where>
    </update>
    
  </changeSet>
</databaseChangeLog>